import React, { useState, useEffect } from 'react';
import MainLayout from '../Layouts/MainLayout';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, ResponsiveContainer, Tooltip, Legend } from 'recharts';
import { router } from '@inertiajs/react';
import ImportSppdModal from '../Components/ImportSppdModal';
import AddSppdModal from '../Components/AddSppdModal';
import toast, { Toaster } from 'react-hot-toast';
import axios from 'axios';

// Helper function to format summary display (auto unit selection)
const formatSummaryDisplay = (value) => {
    if (value >= 1000000000) {
        return {
            value: (value / 1000000000).toFixed(1),
            unit: 'M' // Miliar
        };
    } else if (value >= 1000000) {
        return {
            value: (value / 1000000).toFixed(1),
            unit: 'Jt' // Juta
        };
    } else if (value >= 1000) {
        return {
            value: (value / 1000).toFixed(1),
            unit: 'Rb' // Ribu
        };
    }
    return {
        value: value.toFixed(0),
        unit: ''
    };
};

// Helper function to format Rupiah
const formatRupiah = (value) => {
    return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(value);
};

// Custom Tooltip Component
const CustomTooltip = ({ active, payload, label }) => {
    if (active && payload && payload.length) {
        const data = payload[0]?.payload;
        const fullName = data?.fullName || label;
        const rawDate = data?.rawDate || label;
        const dates = data?.dates; // All specific dates: "7, 11, 18, 19, 20, 28"
        const transactionCount = data?.transactionCount;
        
        // Format date to Indonesian locale
        let formattedDate = '';
        if (rawDate) {
            try {
                // Check if rawDate is in Y-m format (e.g., "2025-11")
                if (/^\d{4}-\d{2}$/.test(rawDate)) {
                    // Monthly aggregation: show "Bulan Tahun" only
                    const [year, month] = rawDate.split('-');
                    const date = new Date(year, parseInt(month) - 1, 1);
                    formattedDate = date.toLocaleDateString('id-ID', { 
                        month: 'long', 
                        year: 'numeric' 
                    });
                } else {
                    // Full date: show day, month, year
                    const date = new Date(rawDate);
                    formattedDate = date.toLocaleDateString('id-ID', { 
                        day: 'numeric',
                        month: 'long', 
                        year: 'numeric' 
                    });
                }
            } catch (e) {
                formattedDate = fullName;
            }
        }
        
        return (
            <div style={{
                backgroundColor: '#fff',
                border: '1px solid #e5e7eb',
                borderRadius: '8px',
                padding: '10px',
                fontSize: '12px',
                boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
                minWidth: '200px'
            }}>
                <p style={{ fontWeight: 'bold', marginBottom: '6px', fontSize: '13px' }}>{formattedDate || fullName}</p>
                {dates && (
                    <p style={{ color: '#6b7280', fontSize: '11px', marginBottom: '6px' }}>
                        üìÖ Tanggal: {dates} | {transactionCount} transaksi
                    </p>
                )}
                {payload.map((entry, index) => (
                    <p key={index} style={{ color: entry.color, margin: '4px 0', fontWeight: '500' }}>
                        {entry.name}: Rp {entry.value}Jt
                    </p>
                ))}
            </div>
        );
    }
    return null;
};

export default function SppdMonitoring({ 
    totalPaidAmount = 0,
    totalTrips = 0,
    averageAmount = 0,
    uniqueCustomers = 0,
    reasons = [],
    availableFilters = [],
    availableReasons = [],
    availableBanks = [],
    selectedFilter = 'all',
    selectedReason = 'all',
    selectedBank = 'all',
    paymentChartData = null,
    tripChartData = null,
    topCustomersByCount = [],
    topCustomersByAmount = [],
    flash = {}
}) {
    const [isFilterDropdownOpen, setIsFilterDropdownOpen] = useState(false);
    const [isReasonDropdownOpen, setIsReasonDropdownOpen] = useState(false);
    const [isBankDropdownOpen, setIsBankDropdownOpen] = useState(false);
    const [isImportModalOpen, setIsImportModalOpen] = useState(false);
    const [isAddModalOpen, setIsAddModalOpen] = useState(false);
    const [chartMode, setChartMode] = useState('monthly');
    const [visibleReasonsCount, setVisibleReasonsCount] = useState(5);
    const [searchQuery, setSearchQuery] = useState('');
    const [searchTimeout, setSearchTimeout] = useState(null);
    
    // Show flash messages with react-hot-toast
    useEffect(() => {
        if (flash?.success) {
            toast.success(flash.success);
        }
        if (flash?.error) {
            toast.error(flash.error);
        }
    }, [flash]);
    
    // Extract available years from availableFilters
    const availableYears = availableFilters
        .filter(f => f.type === 'year')
        .map(f => f.value.replace('year:', ''))
        .filter(year => year && year.trim() !== '');
    
    // Handle search with debounce
    const handleSearchChange = (e) => {
        const value = e.target.value;
        setSearchQuery(value);
        
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        
        const timeout = setTimeout(() => {
            router.get('/sppd', { 
                sheet: selectedFilter,
                reason: selectedReason !== 'all' ? selectedReason : undefined,
                bank: selectedBank !== 'all' ? selectedBank : undefined,
                search: value 
            }, { 
                preserveState: true,
                preserveScroll: true,
                onSuccess: () => {
                    setVisibleReasonsCount(5);
                }
            });
        }, 500);
        
        setSearchTimeout(timeout);
    };
    
    const handleClearSearch = () => {
        setSearchQuery('');
        router.get('/sppd', { 
            sheet: selectedFilter,
            reason: selectedReason !== 'all' ? selectedReason : undefined,
            bank: selectedBank !== 'all' ? selectedBank : undefined
        }, { 
            preserveState: true,
            preserveScroll: true
        });
    };
    
    const filteredReasons = Array.isArray(reasons) ? reasons : [];
    
    const handleFilterChange = (filterValue) => {
        router.get('/sppd', { 
            sheet: filterValue, 
            reason: selectedReason !== 'all' ? selectedReason : undefined,
            bank: selectedBank !== 'all' ? selectedBank : undefined,
            search: searchQuery || undefined 
        }, { 
            preserveState: true,
            preserveScroll: true,
            onSuccess: () => {
                setVisibleReasonsCount(5);
            }
        });
        setIsFilterDropdownOpen(false);
    };
    
    const handleReasonChange = (reasonValue) => {
        router.get('/sppd', { 
            sheet: selectedFilter,
            reason: reasonValue !== 'all' ? reasonValue : undefined,
            bank: selectedBank !== 'all' ? selectedBank : undefined,
            search: searchQuery || undefined 
        }, { 
            preserveState: true,
            preserveScroll: true,
            onSuccess: () => {
                setVisibleReasonsCount(5);
            }
        });
        setIsReasonDropdownOpen(false);
    };
    
    const handleBankChange = (bankValue) => {
        router.get('/sppd', { 
            sheet: selectedFilter,
            reason: selectedReason !== 'all' ? selectedReason : undefined,
            bank: bankValue !== 'all' ? bankValue : undefined,
            search: searchQuery || undefined 
        }, { 
            preserveState: true,
            preserveScroll: true,
            onSuccess: () => {
                setVisibleReasonsCount(5);
            }
        });
        setIsBankDropdownOpen(false);
    };
    
    const getFilterLabel = () => {
        if (!availableFilters || availableFilters.length === 0) return 'All Sheets';
        const filter = availableFilters.find(f => f.value === selectedFilter);
        return filter ? filter.label : 'All Sheets';
    };
    
    const getReasonLabel = () => {
        if (selectedReason === 'all') return 'All Reasons';
        return selectedReason.length > 20 ? selectedReason.substring(0, 20) + '...' : selectedReason;
    };
    
    const getBankLabel = () => {
        if (selectedBank === 'all') return 'All Banks';
        return selectedBank.length > 20 ? selectedBank.substring(0, 20) + '...' : selectedBank;
    };
    
    const handleDeleteSheet = async () => {
        if (selectedFilter === 'all' || selectedFilter.startsWith('year:')) {
            toast.error('Please select a specific sheet to delete');
            return;
        }
        
        if (!confirm(`Are you sure you want to delete all trips in sheet "${selectedFilter}"? This action cannot be undone.`)) {
            return;
        }
        
        try {
            await axios.delete('/sppd/sheet/delete', {
                data: {
                    sheet_name: selectedFilter
                }
            });
            toast.success('Sheet deleted successfully!');
            router.reload();
        } catch (error) {
            toast.error('Failed to delete sheet');
        }
    };
    
    const totalPaidDisplay = formatSummaryDisplay(totalPaidAmount);
    const averageDisplay = formatSummaryDisplay(averageAmount);

    return (
        <MainLayout>
            <Toaster position="top-right" />
            <ImportSppdModal 
                isOpen={isImportModalOpen} 
                onClose={() => setIsImportModalOpen(false)} 
            />
            <AddSppdModal
                isOpen={isAddModalOpen}
                onClose={() => setIsAddModalOpen(false)}
            />
            
            {/* Hero Header with Gradient */}
            <div className="bg-gradient-to-r from-blue-600 via-cyan-500 to-teal-500 text-white p-8 shadow-lg mb-8">
                <div className="max-w-7xl mx-auto">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-4">
                            <div className="bg-white/20 backdrop-blur-sm p-4 rounded-2xl">
                                <svg className="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                            </div>
                            <div>
                                <h1 className="text-4xl font-extrabold tracking-tight">SPPD</h1>
                                <p className="text-purple-100 mt-1 text-sm font-medium">Surat Perintah Perjalanan Dinas</p>
                            </div>
                        </div>
                        <div className="flex gap-3">
                            <button
                                onClick={() => setIsAddModalOpen(true)}
                                className="px-6 py-3 bg-white/20 hover:bg-white/30 backdrop-blur-sm border-2 border-white/50 text-white rounded-xl font-semibold transition flex items-center gap-2"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                                </svg>
                                Add Manual
                            </button>
                            <button
                                onClick={() => setIsImportModalOpen(true)}
                                className="px-6 py-3 bg-white/20 hover:bg-white/30 backdrop-blur-sm border-2 border-white/50 text-white rounded-xl font-semibold transition flex items-center gap-2"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                </svg>
                                Import CSV
                            </button>
                            {selectedFilter !== 'all' && !selectedFilter.startsWith('year:') && (
                                <button
                                    onClick={handleDeleteSheet}
                                    className="px-6 py-3 bg-red-500/80 hover:bg-red-600 backdrop-blur-sm border-2 border-white/50 text-white rounded-xl font-semibold transition flex items-center gap-2"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                    Delete Sheet
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            </div>

            <div className="p-8 bg-gray-50 min-h-screen">
                <div className="max-w-7xl mx-auto">
                    {/* Enhanced Search & Filter Bar */}
                    <div className="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-gray-100">
                        <div className="flex flex-wrap gap-4 items-center">
                            <div className="flex-1 min-w-[300px]">
                                <div className="relative">
                                    <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                        <svg className="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                        </svg>
                                    </div>
                                    <input
                                        type="text"
                                        value={searchQuery}
                                        onChange={handleSearchChange}
                                        placeholder="üîç Search customer, trip number, destination..."
                                        className="w-full pl-12 pr-4 py-3 bg-purple-50 border-2 border-purple-200 rounded-xl focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition-all"
                                    />
                                    {searchQuery && (
                                        <button
                                            onClick={handleClearSearch}
                                            className="absolute right-3 top-3 text-gray-500 hover:text-gray-700"
                                            title="Clear search"
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    )}
                                </div>
                            </div>

                            {/* Sheet Filter Dropdown */}
                            <div className="relative">
                                <button 
                                    onClick={() => setIsFilterDropdownOpen(!isFilterDropdownOpen)}
                                    className="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white border-0 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all cursor-pointer focus:ring-4 focus:ring-purple-200 flex items-center gap-2"
                                >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    <span className="truncate">{getFilterLabel()}</span>
                                    <svg className={`w-4 h-4 transition-transform ${isFilterDropdownOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                        
                                {isFilterDropdownOpen && (
                                    <div className="absolute right-0 mt-2 w-64 bg-white rounded-xl shadow-xl z-50 border-2 border-gray-100 max-h-96 overflow-y-auto">
                                        <div className="py-1">
                                            {availableFilters && availableFilters.length > 0 ? availableFilters.map((filter, index) => {
                                                if (filter.type === 'all') {
                                                    return (
                                                        <button
                                                            key={index}
                                                            onClick={() => handleFilterChange(filter.value)}
                                                            className={`w-full text-left px-4 py-2 hover:bg-purple-50 transition rounded-lg ${selectedFilter === filter.value ? 'bg-purple-100 font-semibold' : ''}`}
                                                        >
                                                            üìä {filter.label}
                                                        </button>
                                                    );
                                                } else if (filter.type === 'year') {
                                                    return (
                                                        <button
                                                            key={index}
                                                            onClick={() => handleFilterChange(filter.value)}
                                                            className={`w-full text-left px-4 py-2 hover:bg-purple-50 transition rounded-lg ${selectedFilter === filter.value ? 'bg-purple-100 font-semibold' : ''}`}
                                                        >
                                                            üìÖ {filter.label}
                                                        </button>
                                                    );
                                                } else {
                                                    return (
                                                        <button
                                                            key={index}
                                                            onClick={() => handleFilterChange(filter.value)}
                                                            className={`w-full text-left px-4 py-2 hover:bg-purple-50 transition rounded-lg ${selectedFilter === filter.value ? 'bg-purple-100 font-semibold' : ''}`}
                                                        >
                                                            üìÑ {filter.label}
                                                        </button>
                                                    );
                                                }
                                            }) : (
                                                <div className="px-4 py-2 text-gray-500 text-sm">No filters available</div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Reason Filter Dropdown */}
                            <div className="relative">
                                <button 
                                    onClick={() => setIsReasonDropdownOpen(!isReasonDropdownOpen)}
                                    className="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white border-0 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all cursor-pointer focus:ring-4 focus:ring-purple-200 flex items-center gap-2"
                                >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                                    </svg>
                                    <span className="truncate">{getReasonLabel()}</span>
                                    <svg className={`w-4 h-4 transition-transform ${isReasonDropdownOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                        
                                {isReasonDropdownOpen && (
                                    <div className="absolute right-0 mt-2 w-72 bg-white rounded-xl shadow-xl z-50 border-2 border-gray-100 max-h-96 overflow-y-auto">
                                        <div className="py-1">
                                            <button
                                                onClick={() => handleReasonChange('all')}
                                                className={`w-full text-left px-4 py-2 hover:bg-pink-50 transition rounded-lg ${selectedReason === 'all' ? 'bg-pink-100 font-semibold' : ''}`}
                                            >
                                                üìã All Reasons
                                            </button>
                                            {availableReasons && availableReasons.length > 0 ? availableReasons.map((reason, index) => (
                                                <button
                                                    key={index}
                                                    onClick={() => handleReasonChange(reason)}
                                                    className={`w-full text-left px-4 py-2 hover:bg-pink-50 transition rounded-lg ${selectedReason === reason ? 'bg-pink-100 font-semibold' : ''}`}
                                                    title={reason}
                                                >
                                                    üíº {reason}
                                                </button>
                                            )) : (
                                                <div className="px-4 py-2 text-gray-500 text-sm">No reasons available</div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            {/* Bank Filter Dropdown */}
                            <div className="relative">
                                <button 
                                    onClick={() => setIsBankDropdownOpen(!isBankDropdownOpen)}
                                    className="px-6 py-3 bg-gradient-to-r from-blue-500 to-cyan-500 text-white border-0 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all cursor-pointer focus:ring-4 focus:ring-blue-200 flex items-center gap-2"
                                >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                    </svg>
                                    <span className="truncate">{getBankLabel()}</span>
                                    <svg className={`w-4 h-4 transition-transform ${isBankDropdownOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                        
                                {isBankDropdownOpen && (
                                    <div className="absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-xl z-50 border-2 border-gray-100 max-h-96 overflow-y-auto">
                                        <div className="py-1">
                                            <button
                                                onClick={() => handleBankChange('all')}
                                                className={`w-full text-left px-4 py-2 hover:bg-blue-50 transition rounded-lg ${selectedBank === 'all' ? 'bg-blue-100 font-semibold' : ''}`}
                                            >
                                                üè¶ All Banks
                                            </button>
                                            {availableBanks && availableBanks.length > 0 ? availableBanks.map((bank, index) => (
                                                <button
                                                    key={index}
                                                    onClick={() => handleBankChange(bank)}
                                                    className={`w-full text-left px-4 py-2 hover:bg-blue-50 transition rounded-lg ${selectedBank === bank ? 'bg-blue-100 font-semibold' : ''}`}
                                                    title={bank}
                                                >
                                                    üèõÔ∏è {bank}
                                                </button>
                                            )) : (
                                                <div className="px-4 py-2 text-gray-500 text-sm">No banks available</div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Summary Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        {/* Total Paid Amount Card */}
                        <div className="group relative overflow-hidden bg-gradient-to-br from-blue-500 via-blue-600 to-cyan-600 rounded-3xl shadow-2xl hover:shadow-3xl transition-all duration-500 hover:scale-105">
                            <div className="absolute top-0 right-0 w-40 h-40 bg-white/10 rounded-full -mr-20 -mt-20 group-hover:scale-150 transition-transform duration-700"></div>
                            <div className="relative p-6 text-white">
                                <div className="flex items-start justify-between mb-3">
                                    <div className="bg-white/20 backdrop-blur-sm p-3 rounded-2xl group-hover:rotate-12 transition-transform duration-500">
                                        <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-xs font-medium text-purple-100 mb-1">Total Paid Amount</div>
                                        <div className="text-2xl font-black tracking-tight">
                                            Rp {totalPaidDisplay.value}{totalPaidDisplay.unit}
                                        </div>
                                    </div>
                                </div>
                                <div className="mt-3 pt-3 border-t border-white/20">
                                    <div className="text-xs text-purple-50">{formatRupiah(totalPaidAmount)}</div>
                                </div>
                            </div>
                        </div>

                        {/* Total Trips Card */}
                        <div className="group relative overflow-hidden bg-gradient-to-br from-cyan-500 via-blue-600 to-indigo-600 rounded-3xl shadow-2xl hover:shadow-3xl transition-all duration-500 hover:scale-105">
                            <div className="absolute top-0 right-0 w-40 h-40 bg-white/10 rounded-full -mr-20 -mt-20 group-hover:scale-150 transition-transform duration-700"></div>
                            <div className="relative p-6 text-white">
                                <div className="flex items-start justify-between mb-3">
                                    <div className="bg-white/20 backdrop-blur-sm p-3 rounded-2xl group-hover:rotate-12 transition-transform duration-500">
                                        <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                                        </svg>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-xs font-medium text-cyan-100 mb-1">Total SPPD Trips</div>
                                        <div className="text-2xl font-black tracking-tight">{totalTrips}</div>
                                    </div>
                                </div>
                                <div className="mt-3 pt-3 border-t border-white/20">
                                    <div className="text-xs text-cyan-50">Perjalanan Dinas</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Main Content Grid */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Dual Charts Stacked Vertically */}
                        <div className="space-y-6">
                            {/* Chart 1: Rencana Tanggal Bayar (Payment Date) */}
                            <div className="bg-white rounded-xl p-6 shadow-lg">
                                <h3 className="text-lg font-bold mb-4 text-amber-700">üìÖ Rencana Tanggal Bayar</h3>
                                
                                {paymentChartData && paymentChartData.length > 0 ? (
                                    <ResponsiveContainer width="100%" height={250}>
                                        <BarChart data={paymentChartData}>
                                            <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                                            <XAxis 
                                                dataKey="sheet" 
                                                tick={{ fill: '#6b7280', fontSize: 10 }}
                                                angle={paymentChartData.length > 1 ? -15 : 0}
                                                textAnchor={paymentChartData.length > 1 ? "end" : "middle"}
                                                height={paymentChartData.length > 1 ? 60 : 30}
                                            />
                                            <YAxis 
                                                tickFormatter={(value) => `${value}Jt`}
                                                tick={{ fill: '#6b7280', fontSize: 10 }}
                                            />
                                            <Tooltip content={<CustomTooltip />} />
                                            <Bar 
                                                dataKey="total" 
                                                fill="#f59e0b" 
                                                radius={[8, 8, 0, 0]} 
                                                name="Total Amount (Jt)"
                                                barSize={paymentChartData.length === 1 ? 80 : undefined}
                                            />
                                        </BarChart>
                                    </ResponsiveContainer>
                                ) : (
                                    <div className="h-[250px] flex items-center justify-center text-gray-500">
                                        <div className="text-center">
                                            <svg className="w-12 h-12 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                            </svg>
                                            <p className="font-semibold mb-1 text-sm">Tidak ada data</p>
                                            <p className="text-xs">Data tanggal bayar tidak tersedia</p>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Chart 2: Tanggal Mulai Trip */}
                            <div className="bg-white rounded-xl p-6 shadow-lg">
                                <h3 className="text-lg font-bold mb-4 text-purple-700">‚úàÔ∏è Tanggal Mulai Trip</h3>
                                
                                {tripChartData && tripChartData.length > 0 ? (
                                    <ResponsiveContainer width="100%" height={250}>
                                        <BarChart data={tripChartData}>
                                            <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                                            <XAxis 
                                                dataKey="sheet" 
                                                tick={{ fill: '#6b7280', fontSize: 10 }}
                                                angle={tripChartData.length > 1 ? -15 : 0}
                                                textAnchor={tripChartData.length > 1 ? "end" : "middle"}
                                                height={tripChartData.length > 1 ? 60 : 30}
                                            />
                                            <YAxis 
                                                tickFormatter={(value) => `${value}Jt`}
                                                tick={{ fill: '#6b7280', fontSize: 10 }}
                                            />
                                            <Tooltip content={<CustomTooltip />} />
                                            <Bar 
                                                dataKey="total" 
                                                fill="#a855f7" 
                                                radius={[8, 8, 0, 0]} 
                                                name="Total Amount (Jt)"
                                                barSize={tripChartData.length === 1 ? 80 : undefined}
                                            />
                                        </BarChart>
                                    </ResponsiveContainer>
                                ) : (
                                    <div className="h-[250px] flex items-center justify-center text-gray-500">
                                        <div className="text-center">
                                            <svg className="w-12 h-12 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                            </svg>
                                            <p className="font-semibold mb-1 text-sm">Tidak ada data</p>
                                            <p className="text-xs">Data tidak tersedia</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Reasons for Trip List */}
                        <div className="bg-white rounded-lg p-6 shadow flex flex-col max-h-[540px]">
                            <div className="mb-4 flex-shrink-0">
                                <h3 className="text-lg font-bold">Alasan Perjalanan</h3>
                                
                                {searchQuery && (
                                    <div className="text-sm text-gray-600 mt-2">
                                        {filteredReasons.length > 0 ? (
                                            <span>Found <strong>{filteredReasons.length}</strong> result{filteredReasons.length !== 1 ? 's' : ''} for "<strong>{searchQuery}</strong>"</span>
                                        ) : (
                                            <span>No results found for "<strong>{searchQuery}</strong>"</span>
                                        )}
                                    </div>
                                )}
                            </div>
                            
                            {/* Scrollable Content Area */}
                            <div className="flex-1 overflow-y-auto pr-2 space-y-3 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100">
                                {filteredReasons && filteredReasons.length > 0 ? (
                                    <>
                                        {filteredReasons.slice(0, visibleReasonsCount).map((item, index) => (
                                            <div key={index} className="rounded-lg p-4 bg-purple-50 hover:bg-purple-100 transition">
                                                <div className="flex justify-between items-start mb-3">
                                                    <div className="flex-1 min-w-0 pr-2">
                                                        <p className="font-semibold text-gray-900 text-base">{item.reason}</p>
                                                        <p className="text-sm text-gray-600">{item.trips}</p>
                                                        {item.destinations && (
                                                            <p className="text-xs text-purple-700 mt-1 italic" title={item.destinations}>
                                                                üìç {item.destinations.length > 50 ? item.destinations.substring(0, 50) + '...' : item.destinations}
                                                            </p>
                                                        )}
                                                    </div>
                                                    <p className="text-xl font-bold flex-shrink-0 text-purple-600">{item.amount}</p>
                                                </div>
                                                <button
                                                    onClick={() => {
                                                        const params = new URLSearchParams({
                                                            reason: item.reason,
                                                            sheet: selectedFilter
                                                        });
                                                        if (selectedReason !== 'all') params.append('reasonFilter', selectedReason);
                                                        if (selectedBank !== 'all') params.append('bank', selectedBank);
                                                        router.visit(`/sppd/destination-detail?${params.toString()}`);
                                                    }}
                                                    className="w-full mt-2 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 transition font-medium text-sm"
                                                >
                                                    Lihat Detail ‚Üí
                                                </button>
                                            </div>
                                        ))}
                                    </>
                                ) : (
                                    <div className="text-center text-gray-500 py-8">
                                        {searchQuery ? (
                                            <div>
                                                <svg className="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                                </svg>
                                                <p className="font-medium">No reasons found</p>
                                                <p className="text-sm mt-1">Try a different search term</p>
                                            </div>
                                        ) : (
                                            <p>Tidak ada data alasan perjalanan</p>
                                        )}
                                    </div>
                                )}
                            </div>
                            
                            {/* Load More Button */}
                            {filteredReasons.length > visibleReasonsCount && (
                                <div className="mt-4 pt-4 border-t border-gray-200 flex-shrink-0">
                                    <button
                                        onClick={() => setVisibleReasonsCount(prev => Math.min(prev + 10, filteredReasons.length))}
                                        className="w-full px-4 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg transition font-semibold flex items-center justify-center gap-2 text-sm"
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                        </svg>
                                        <span>Muat Lebih Banyak (+10 lagi - {filteredReasons.length - visibleReasonsCount} tersisa)</span>
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Analytics Section */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                        {/* Top 10 Customers by Trip Count */}
                        <div className="bg-white rounded-lg p-6 shadow">
                            <h3 className="text-lg font-bold mb-4">Top 10 Customers (Trips)</h3>
                            <div className="space-y-2 max-h-[320px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300">
                                {topCustomersByCount && topCustomersByCount.length > 0 ? (
                                    topCustomersByCount.map((customer, index) => (
                                        <div key={index} className="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                            <div className="flex items-center gap-3 flex-1 min-w-0">
                                                <div className={`flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${
                                                    index === 0 ? 'bg-yellow-400 text-yellow-900' :
                                                    index === 1 ? 'bg-gray-300 text-gray-700' :
                                                    index === 2 ? 'bg-orange-400 text-orange-900' :
                                                    'bg-gray-200 text-gray-600'
                                                }`}>
                                                    {index + 1}
                                                </div>
                                                <p className="text-sm font-medium text-gray-900 truncate">{customer.name}</p>
                                            </div>
                                            <span className="text-sm font-bold text-purple-600">{customer.count} trips</span>
                                        </div>
                                    ))
                                ) : (
                                    <p className="text-center text-gray-500 py-4 text-sm">No data</p>
                                )}
                            </div>
                        </div>

                        {/* Top 10 Customers by Amount */}
                        <div className="bg-white rounded-lg p-6 shadow">
                            <h3 className="text-lg font-bold mb-4">Top 10 Customers (Amount)</h3>
                            <div className="space-y-2 max-h-[320px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300">
                                {topCustomersByAmount && topCustomersByAmount.length > 0 ? (
                                    topCustomersByAmount.map((customer, index) => (
                                        <div key={index} className="flex items-center justify-between p-2 hover:bg-gray-50 rounded">
                                            <div className="flex items-center gap-3 flex-1 min-w-0">
                                                <div className={`flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${
                                                    index === 0 ? 'bg-yellow-400 text-yellow-900' :
                                                    index === 1 ? 'bg-gray-300 text-gray-700' :
                                                    index === 2 ? 'bg-orange-400 text-orange-900' :
                                                    'bg-gray-200 text-gray-600'
                                                }`}>
                                                    {index + 1}
                                                </div>
                                                <p className="text-sm font-medium text-gray-900 truncate">{customer.name}</p>
                                            </div>
                                            <div className="flex flex-col items-end">
                                                <span className="text-sm font-bold text-green-600">{customer.total}</span>
                                                <span className="text-xs text-gray-500">{customer.count} trips</span>
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <p className="text-center text-gray-500 py-4">No data</p>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </MainLayout>
    );
}
